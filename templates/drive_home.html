{% extends "base_drive_layout.html" %}

{% block title %}{{ current_folder_name }} - My Drive{% endblock %}

{% block content %}
    <div class="container-fluid mt-3">
        {# Breadcrumbs - adapt from file_list.html #}
        <h1 class="h3 mb-3">{{ current_folder_name | default("My Files") }}</h1>
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{{ url_for('list_files', folder_id=None) }}">My Files</a></li>
                    {% for crumb in breadcrumbs %}
                        {% if loop.last %}
                            <li class="breadcrumb-item active" aria-current="page">
                                {{ crumb.nombre }}
                            </li>
                        {% else %}
                            <li class="breadcrumb-item">
                                <a href="{{ url_for('list_files', folder_id=crumb.id) }}">{{ crumb.nombre }}</a>
                            </li>
                        {% endif %}
                    {% endfor %}
            </ol>
        </nav>

        {# Action buttons - Create Folder, etc. (can be moved to header/sidebar later) #}
        {# ... #}

        {# Flash messages - adapt from file_list.html #}
        {% with messages = get_flashed_messages(with_categories=true) %}
            {# ... message logic ... #}
        {% endwith %}

        {# File and Folder Table/List - adapt from file_list.html #}
        {% if folders or documents %}
            <table class="table table-hover">
                {# ... table headers with sorting links ... #}
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Date Modified/Uploaded</th>
                        <th>Size</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                        {% for folder in folders %}
                        <tr>
                            <td>
                                <i class="bi bi-folder-fill me-2" style="color: #ffcc00;"></i> 
                                <a href="{{ url_for('list_files', folder_id=folder.id_carpeta, q=search_term or None) }}">{{ folder.nombre }}</a>
                            </td>
                            <td>Folder</td>
                            <td>{{ folder.fecha_modificacion.strftime('%Y-%m-%d %H:%M') if folder.fecha_modificacion else 'N/A' }}</td>
                            <td>--</td>
                            <td>
                                <a href="{{ url_for('rename_folder', folder_id=folder.id_carpeta) }}" class="btn btn-sm btn-warning action-btn" title="Rename Folder">Rename</a>
                                <a href="{{ url_for('move_folder', folder_id=folder.id_carpeta) }}" class="btn btn-sm btn-secondary action-btn" title="Move Folder">Move</a>
                                <form method="POST" action="{{ url_for('delete_folder', folder_id=folder.id_carpeta) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this folder? It must be empty.');">
                                    <button type="submit" class="btn btn-sm btn-danger action-btn" title="Delete Folder (Must be empty)">Delete</button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}

                    {% for doc in documents %}
                    <tr>
                        <td>{# File Icon and Name #}
                                <i class="bi bi-file-earmark-text-fill me-2" style="color: #6c757d;"></i>
                            {{ doc.titulo_original }}
                            {# Display favorite indicator if set #}
                            {% if doc.favorito %}<span class="badge bg-warning text-dark ms-1">Fav</span>{% endif %}
                        </td>
                            {# Display category name using relationship, fallback to 'File' #}
                        <td>{{ doc.categoria.nombre if doc.categoria else 'File' }}</td>
                            {# Display upload date #}
                        <td>{{ doc.fecha_carga.strftime('%Y-%m-%d %H:%M') if doc.fecha_carga else 'N/A' }}</td>
                            {# Display formatted file size using custom filter #}
                        <td>{{ doc.file_size | format_file_size if doc.file_size is not none else 'N/A' }}</td>
                        <td>{# Document Actions: Download, Edit, Move, Delete #}
                            <a href="{{ url_for('download_file', doc_id=doc.id_documento) }}" class="btn btn-sm btn-info action-btn" title="Download">Download</a>
                            <a href="{{ url_for('edit_file', doc_id=doc.id_documento) }}" class="btn btn-sm btn-warning action-btn" title="Edit Metadata">Edit</a>
                            <a href="{{ url_for('move_file', doc_id=doc.id_documento) }}" class="btn btn-sm btn-secondary action-btn" title="Move File">Move</a>
                            <form method="POST" action="{{ url_for('delete_file', doc_id=doc.id_documento) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file?');">
                                    <button type="submit" class="btn btn-sm btn-danger action-btn" title="Delete">Delete</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <div class="alert alert-info">This folder is empty.</div>
        {% endif %}
    </div>
{% endblock %}

{% block scripts %}
    {# Add any JavaScript specific to the file view page here #}
{% endblock %}