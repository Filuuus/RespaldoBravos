<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    {# Display current folder name in the browser tab title #}
    <title>{{ current_folder_name }} - My Files</title> 
    
    {# Load Bootstrap CSS for styling #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    {# Load Bootstrap Icons CSS #}
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    {# Optional custom styles #}
    <style>
        body { padding-top: 20px; }
        .action-btn { margin-right: 5px; }
        /* Styles for icons if needed, although inline style is used below */
        /* .folder-icon::before { content: "\f3d7"; font-family: bootstrap-icons; margin-right: 5px; } */
        /* .file-icon::before { content: "\f361"; font-family: bootstrap-icons; margin-right: 5px; } */
    </style>
</head>
<body>
    <div class="container mt-4">
        
        {# --- START: Breadcrumb Navigation --- #}
        <nav aria-label="breadcrumb" style="--bs-breadcrumb-divider: '>';"> {# Added style #}
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="{{ url_for('list_files', folder_id=None) }}">My Files (Root)</a>
                </li>
                {% for crumb in breadcrumbs %}
                    {% if loop.last %}
                        <li class="breadcrumb-item active" aria-current="page">
                            {{ crumb.nombre }}
                        </li>
                    {% else %}
                        <li class="breadcrumb-item">
                            <a href="{{ url_for('list_files', folder_id=crumb.id) }}">{{ crumb.nombre }}</a>
                        </li>
                    {% endif %}
                {% endfor %}
            </ol>
        </nav>
        {# --- END: Breadcrumb Navigation --- #}
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
            <h1 class="h3 mb-0 me-3">{{ current_folder_name }}</h1> 
            
            <div class="d-flex align-items-center flex-wrap">
                <form method="GET" action="{{ url_for('list_files', folder_id=current_folder_id) }}" class="d-inline-flex me-2 mb-1"> 
                    {# Hidden inputs preserve current sorting when searching #}
                    <input type="hidden" name="sort_by" value="{{ sort_by or 'name' }}">
                    <input type="hidden" name="sort_dir" value="{{ sort_dir or 'asc' }}">
                    {# Search input field, pre-filled with current search term #}
                    <input type="search" name="q" class="form-control form-control-sm me-1" placeholder="Search current folder..." value="{{ search_term or '' }}" style="width: auto;">
                    <button type="submit" class="btn btn-sm btn-outline-secondary">Search</button>
                </form>
                
                <form method="POST" action="{{ url_for('create_folder', parent_folder_id=current_folder_id if current_folder_id else None) }}" class="d-inline-flex me-2 mb-1">
                    <input type="text" name="folder_name" class="form-control form-control-sm me-1" placeholder="New folder name" required style="width: auto;">
                    <button type="submit" class="btn btn-sm btn-success text-nowrap">Create Folder</button> 
                </form>
                
                <a href="{{ url_for('upload_route', parent_folder_id=current_folder_id) }}" class="btn btn-sm btn-primary me-2 mb-1 text-nowrap">Upload File</a> 
                <a href="{{ url_for('logout') }}" class="btn btn-sm btn-secondary mb-1 text-nowrap">Logout</a> 
            </div>
        </div>
        <hr class="mt-0"> 

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                <div class="alert alert-{{ category or 'info' }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if folders or documents %}
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">
                        {# Logic to determine next sort direction for 'name' #}
                        {% set next_dir_name = 'desc' if sort_by == 'name' and sort_dir == 'asc' else 'asc' %}
                        {# Link to sort by name, preserving current folder and search term #}
                        <a href="{{ url_for('list_files', folder_id=current_folder_id, sort_by='name', sort_dir=next_dir_name, q=search_term or None) }}">Name</a>
                        {# Show sort indicator icon if currently sorting by name #}
                        {% if sort_by == 'name' %}<i class="bi bi-sort-{{ 'alpha-up' if sort_dir == 'asc' else 'alpha-down' }}"></i>{% endif %}
                    </th>
                    
                    <th scope="col">
                        {% set next_dir_type = 'desc' if sort_by == 'type' and sort_dir == 'asc' else 'asc' %}
                        <a href="{{ url_for('list_files', folder_id=current_folder_id, sort_by='type', sort_dir=next_dir_type, q=search_term or None) }}">Type</a>
                         {% if sort_by == 'type' %}<i class="bi bi-sort-{{ 'alpha-up' if sort_dir == 'asc' else 'alpha-down' }}"></i>{% endif %}
                   </th>
                    
                    <th scope="col">
                        {% set next_dir_date = 'desc' if sort_by == 'date' and sort_dir == 'asc' else 'asc' %}
                        <a href="{{ url_for('list_files', folder_id=current_folder_id, sort_by='date', sort_dir=next_dir_date, q=search_term or None) }}">Date Modified/Uploaded</a>
                        {% if sort_by == 'date' %}<i class="bi bi-sort-{{ 'down' if sort_dir == 'asc' else 'up' }}"></i>{% endif %}
                    </th>
                    
                    <th scope="col">
                         {% set next_dir_size = 'desc' if sort_by == 'size' and sort_dir == 'asc' else 'asc' %}
                         <a href="{{ url_for('list_files', folder_id=current_folder_id, sort_by='size', sort_dir=next_dir_size, q=search_term or None) }}">Size</a>
                         {% if sort_by == 'size' %}<i class="bi bi-sort-{{ 'down' if sort_dir == 'asc' else 'up' }}"></i>{% endif %}
                    </th>

                    <th scope="col">Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for folder in folders %}
                <tr>
                    <td>{# Folder Icon and Link to navigate into folder #}
                        <i class="bi bi-folder-fill me-2" style="color: #ffcc00;"></i> 
                        <a href="{{ url_for('list_files', folder_id=folder.id_carpeta, q=search_term or None) }}">{{ folder.nombre }}</a>
                    </td>
                    <td>Folder</td> {# Static type for folders #}
                    <td>{{ folder.fecha_modificacion.strftime('%Y-%m-%d %H:%M') if folder.fecha_modificacion else 'N/A' }}</td> {# Folder modification date #}
                    <td>--</td> {# Folders have no size here #}
                    <td>{# Folder Actions: Rename, Delete #}
                        <a href="{{ url_for('rename_folder', folder_id=folder.id_carpeta) }}" class="btn btn-sm btn-warning action-btn" title="Rename Folder">Rename</a>
                        <form method="POST" action="{{ url_for('delete_folder', folder_id=folder.id_carpeta) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this folder? It must be empty.');">
                             <button type="submit" class="btn btn-sm btn-danger action-btn" title="Delete Folder (Must be empty)">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}

                {% for doc in documents %}
                <tr>
                    <td>{# File Icon and Name #}
                         <i class="bi bi-file-earmark-text-fill me-2" style="color: #6c757d;"></i> 
                        {{ doc.titulo_original }}
                        {# Display favorite indicator if set #}
                        {% if doc.favorito %}<span class="badge bg-warning text-dark ms-1">Fav</span>{% endif %}
                    </td>
                     {# Display category name using relationship, fallback to 'File' #}
                    <td>{{ doc.categoria.nombre if doc.categoria else 'File' }}</td>
                     {# Display upload date #}
                    <td>{{ doc.fecha_carga.strftime('%Y-%m-%d %H:%M') if doc.fecha_carga else 'N/A' }}</td>
                     {# Display formatted file size using custom filter #}
                    <td>{{ doc.file_size | format_file_size if doc.file_size is not none else 'N/A' }}</td>
                    <td>{# Document Actions: Download, Edit, Move, Delete #}
                        <a href="{{ url_for('download_file', doc_id=doc.id_documento) }}" class="btn btn-sm btn-info action-btn" title="Download">Download</a>
                        <a href="{{ url_for('edit_file', doc_id=doc.id_documento) }}" class="btn btn-sm btn-warning action-btn" title="Edit Metadata">Edit</a>
                        <a href="{{ url_for('move_file', doc_id=doc.id_documento) }}" class="btn btn-sm btn-secondary action-btn" title="Move File">Move</a>
                        <form method="POST" action="{{ url_for('delete_file', doc_id=doc.id_documento) }}" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this file?');">
                             <button type="submit" class="btn btn-sm btn-danger action-btn" title="Delete">Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {# Message displayed if folder is empty #}
        {% else %}
        <div class="alert alert-info" role="alert">
            This folder is empty.
        </div>
        {% endif %}

    </div>
    {# Load Bootstrap JS Bundle #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>